<!DOCTYPE html>
<html lang="en-us">

  <head>
  <meta charset="UTF-8">
  <title>rspeare.github.io</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <link rel="stylesheet" href="/css/normalize.css">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/cayman.css">
</head>


  <body>
    <section class="page-header">
  <h1 <a href="/" class="project-name">rspeare.github.io </a> </h1> 
  <h2 class="project-tagline"></h2>
  <a href="/" class="btn">Blog</a>  

  <a class="btn" <a href="https://github.com/rspeare"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">rspeare</span></a>
 </a>


  <a class="btn" <a href="https://twitter.com/waiting4spark"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">waiting4spark</span></a>
 </a>

<a href="/about/" class="btn">About</a>  
</section>


    <section class="main-content">
      
      <style TYPE="text/css">
code.has-jax {font: inherit; font-size: 100%; background: inherit; border: inherit;}
</style>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'] // removed 'code' entry
    }
});
MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

<h2>Importance Sampling</h2>
<p class="meta">09 Jul 2014</p>

<div dir="ltr" style="text-align: left;" trbidi="on">So, last week I was 
learning a great deal about something called the VEGAS algorithm, which was 
first presented by Peter LePage in the 60's or 70's. It's a very clever way of 
going about importance sampling, which is a Monte Carlo method for 
integration. 

To start, let's say we would like to evaluate the integral: 

\begin{eqnarray} 
I &amp;=&amp; \int f(\mathbf{x})d^n x 
\end{eqnarray} 

Where $\mathbf{x}$ is an n-dimensional vector and we are integrating over 
n-dimensional space, with jacobian $d^n x$. Let's say that this function, our 
integrand, $f(\mathbf{x})$, is purely intractable by analytic means -- it is 
impossible to integrate with pen and paper. Luckily, we can estimate this 
integral by other (Monte Carlo) means. 

A naive strategy would be to construct a uniform Probability density function 
(PDF) on the integration region, and sample randomly from this PDF to get the 
independent variable $\mathbf{x}$ and the corresponding integrand value 
$f(\mathbf{x}$. This would be essentially obtaining an expectation value. 
Let's take a look in 1-D: 

\begin{eqnarray} 
I &amp;=&amp; \int_a^b f(x) dx \\ 
g(x) &amp;=&amp; \frac{1}{(b-a)} 
\eta \sim P(x) \\ 
\langle f(x) \rangle_{g(x)} &amp;=&amp; \int_a^b f(x) g(x) dx = \frac{1}{b-a}I 
\end{eqnarray} 

As the number of our random samples, $\eta$ gets large, we can use the law of 
large numbers to assume that our discrete mean closes in on the "true" mean, 
which, in this case, is the value of the integral $I$: 

\begin{eqnarray} 
\langle f(x) \rangle_g &amp;=&amp; \lim_{N \to \infty} \sum_i^N 
\frac{f(\eta_i)}{N} \ \ \ \ \ \eta \sim g(x) \\ 
&amp;=&amp; (b-a) \int f(x) dx 
\end{eqnarray} 

So that's pretty cool! We have estimated an integral by taking a "strange type 
of mean", drawing random variables from some arbitrary -- well, in this case 
uniform -- PDF $g(x)$. One way to take care of our strange factor $b-a$ above 
is to "normalize" 

\begin{eqnarray} 
I &amp;=&amp; \int f(x) dx = \int \frac{f(x)}{g(x)}g(x)dx 
\end{eqnarray} 

We see that the above is just our old integral $I$, but we find that, in 
numerical means, the last term on the right is equivalent to finding the 
expectation value of $f/g$ "under" $g(x)$, which means: 

\begin{eqnarray} 
I &amp;=&amp; \int \frac{f(x)}{g(x)}g(x)dx = \langle \frac{f(x)}{g(x)} 
\rangle_g \\ 
&amp;=&amp; \lim_{N\to \infty} \sum_i^N \frac{1}{N}\frac{f(\eta_i)}{g(\eta_i)} 
\ \ \ \ \ \eta \sim g(x) 
\end{eqnarray} 

So our random sample $\eta$ are drawn from the PDF $g(x)$, and we are 
searching for the mean value of this \textbf{ratio}, $\frac{f}{g}$. 
Interesting trick right? 

Now our next step in this numerical procedure is to estimate the variance in 
our "integral estimator", which is what we will call our sum of the ratios, 
above: 

\begin{eqnarray} 
\hat{I} &amp;=&amp; \sum_i^N \frac{1}{N}\frac{f(\eta_i)}{g(\eta_i)} \ \ \ \ \ 
\eta \sim g(x) \\ 
\lim_{N\to \infty} \hat{I} &amp;=&amp; I 
\end{eqnarray} 

What is $\sigma^2_I$? We construct our estimator of the variance in the usual 
way: the mean of the square minus the square of the mean: 

\begin{eqnarray} 
\sigma^2_I &amp;=&amp; \langle (\hat{I}-I)^2 \rangle = \langle \hat{I}^2 
\rangle - \langle \hat{I} \rangle^2 \\ 
&amp;=&amp; \langle \left(\frac{f(x)}{g(x)}\right)^2 \rangle_g - \langle 
\frac{f(x)}{g(x)}\rangle_g^2 \\ 
&amp;=&amp; \int \left(\frac{f(x)}{g(x)}\right)^2  g(x) dx - \left( \int f(x) 
dx\right)^2\\ 
&amp;=&amp; \int \frac{\vert f(x) \vert^2}{g(x)^2} g(x) dx - \left( \int f(x) 
dx\right)^2\\ 
\end{eqnarray} 

Numerically, this final equation can be represented by another discrete sum, 
which we will call our estimate of the variance: 

\begin{eqnarray} 
\hat{\sigma}^2_I &amp;=&amp; \frac{ \sum_i^N \frac{\vert f(\eta_i) 
\vert^2}{g(\eta_i)^2}- \left( \sum_i^N 
\frac{f(\eta_i)}{g(\eta_i)}\right)^2}{N^2}  \ \ \ \ \ \ \ \eta \sim g(x) 
\end{eqnarray} 

Now since we are subtracting by an estimator of the mean and not the true 
mean, we find that the above estimator of the variance is biased, by a factor 
of $\frac{N-1}{N}$, so we should rewrite our denominator above with an 
$N(N-1)$, as we are used to. 


----------------------------------------------------------------------------------------------------------- 

So what choice of the probability density $g(x)$ minimizes the variance in our 
integral estimate? Intuitively, we can expect that if $g(x)$ closely matches 
the behaviour of $f(x)$ over the whole domain of integration, the ratio $f/g$ 
would remain constant, and we expect very small variance. Let's take a 
function derivative of our expression for variance $\sigma^2_I$ with a 
lagrange multiplier $\lambda$ in place to maintain the constraint of $g(x)$'s 
normalization as a probability density function: 

\begin{eqnarray} 
\sigma^2_I &amp;=&amp; \int \frac{\vert f(x)\vert^2}{g(x)}dx - (\int f(x) 
dx)^2 + \lambda \left(\int g(x) dx -1 \right) \\ 
\frac{\delta \sigma^2_I}{\delta g}&amp;=&amp;  \int \left[ \frac{-\vert 
f(x)\vert^2}{g(x)^2}+\lambda \right] dx 
\end{eqnarray} 

We see that this derivative above will be zero only when the integrand is zero 
for all x, and so we have 

\begin{eqnarray} 
g(x) &amp;=&amp; \lambda \vert f(x) \vert 
\end{eqnarray} 

Since we have already assumed $g(x)$ to be a PDF, we need not place the 
absolute value sign on the LHS, above, because PDF's are positive definite (in 
order to make their cumulative PDF's  $G(x)=\int_{-\infty}^x 
g(x^\prime)dx^\prime $ monotonically increasing). Plugging in our 
normalization constraint, once again, we find: 

\begin{eqnarray} 
\int g(x) dx &amp;=&amp; \lambda \int \vert f(x) \vert dx \\ 
1 &amp;=&amp; \lambda \int \vert f(x) \vert dx \\ 
\frac{1}{\int \vert f(x) \vert dx} &amp;=&amp; \lambda \\ 
\end{eqnarray} 

and so the optimum PDF is 

\begin{eqnarray} 
g(x) &amp;=&amp; \frac{\vert f(x) \vert}{\int \vert f(x) \vert dx} 
\end{eqnarray} 

or, is proportional to absolute value of our integrand -- with some 
normalization constant -- at every $x$. This is pretty cool! One can find, by 
taking a similar functional derivative in N-dimensions, that if $g(x)$, the 
multidimensional PDF is separable across the components of our vector 
$\mathbf{x}$ 

\begin{eqnarray} 
g(\mathbf{x}) &amp;=&amp; \Pi_i^N g_i (x_i) 
\end{eqnarray} 

then the optimum $g(\mathbf{x})$ takes the following form: 

\begin{eqnarray} 
g_j (x_j) &amp;=&amp; \frac{\left[ \int \frac{\vert f(x) \vert^2}{\Pi_{i \ne 
j} g_i (x_i) } d^{n-1}x\right]^{1/2}}{\int dx_j \left[ \int \frac{\vert f(x) 
\vert^2}{\Pi_{i \ne j} g_i (x_i) } d^{n-1}x\right]^{1/2}} 
\end{eqnarray} 


----------------------------------------------------------------------------------------------------------- 

So how does VEGAS go about approximating these "optimum" multidimensional 
distributions? By changing the sampling grid. LePage did a very clever thing 
when he constructed an algorithm that initially samples some integrand 
uniformly, essentially adopting the following PDF: 

\begin{eqnarray} 
g_0(\mathbf{x}) &amp;=&amp; \frac{1}{V_n} 
\end{eqnarray} 

Where $V_n$, is the n-dimensional volume of the integration region. But then, 
once these samples are taken, he perturbs the grid spacings -- keeping the 
number of samples constant -- in proportion with the absolute value of the 
integrand, $f(\mathbf{x})$. What this essentially does is match 
$g(\mathbf{x})$'s peaks to $f(\mathbf{x})$'s peaks, be they high or low, and 
over successive sampling rounds -- let's say M of them -- the "grid", or 
$g(\mathbf{x})$, gets perfectly attuned to the characteristics of 
$f(\mathbf{x})$. 
</div>




      <footer class="site-footer">
  <span class="site-footer-owner"><a href="http://localhost:4000">rspeare.github.io</a> is maintained by <a href="">rspeare</a>.</span>
  <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>

  <a href="https://www.linkedin.com/in/rob-speare-aaa6834a">
    <span class="icon  icon--linkedin">
      <svg viewBox="0 0 10000 10000" >
        <path fill="#828282" d="M150.65,100.682c0,27.992-22.508,50.683-50.273,50.683c-27.765,0-50.273-22.691-50.273-50.683
        C50.104,72.691,72.612,50,100.377,50C128.143,50,150.65,72.691,150.65,100.682z M143.294,187.333H58.277V462h85.017V187.333z
        M279.195,187.333h-81.541V462h81.541c0,0,0-101.877,0-144.181c0-38.624,17.779-61.615,51.807-61.615
        c31.268,0,46.289,22.071,46.289,61.615c0,39.545,0,144.181,0,144.181h84.605c0,0,0-100.344,0-173.915
        s-41.689-109.131-99.934-109.131s-82.768,45.369-82.768,45.369V187.333z"/>
      </svg>
    </span>

    <span class="username"></span>
  </a>

</footer>
 

    </section>

  </body>
</html>
